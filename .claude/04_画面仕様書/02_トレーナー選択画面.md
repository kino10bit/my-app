# トレーナー選択画面 設計書

## 📋 画面概要

### 目的
ユーザーが習慣形成をサポートしてくれるトレーナーキャラクターを選択する画面。

### 機能概要
- 利用可能なトレーナー一覧の表示
- トレーナーの詳細情報の確認
- トレーナーの選択・変更
- 選択結果の確定

## 🎯 ユーザー体験

### ユーザーストーリー
```
ユーザーとして、
自分の性格や好みに合うトレーナーを選択したい。
そうすることで、習慣形成のモチベーションを維持できる。
```

### 主要なユースケース
1. **初回選択**: 初めてアプリを使用するユーザーがトレーナーを選択
2. **変更**: 既存ユーザーが現在のトレーナーを変更
3. **比較**: 複数のトレーナーの特徴を比較検討

## 🏗 UI構造

### レイアウト構成
```
┌─────────────────────┐
│      ヘッダー         │
├─────────────────────┤
│                     │
│   トレーナー一覧      │
│   ┌─────────────┐   │
│   │ トレーナーA   │   │
│   │ アバター       │   │
│   │ 基本情報       │   │
│   │ [選択ボタン]   │   │
│   └─────────────┘   │
│   ┌─────────────┐   │
│   │ トレーナーB   │   │
│   └─────────────┘   │
│                     │
├─────────────────────┤
│   選択中詳細表示      │
├─────────────────────┤
│    [確定ボタン]      │
└─────────────────────┘
```

### コンポーネント構成

#### 1. ヘッダー
- **要素**: タイトル「トレーナー選択」
- **スタイル**: 中央配置、大きめフォント

#### 2. トレーナーカード
- **アバター表示**: 
  - 画像ファイル（PNG形式、400x400px）
  - プレースホルダー: トレーナー名の頭文字 + タイプ別絵文字
- **基本情報**:
  - トレーナー名
  - タイプ（エネルギッシュ、穏やか、厳格、優しい、やる気満々）
  - 説明文
- **音声ボタン**: 「🔊 声を聞く」ボタンで音声サンプル再生
- **選択ボタン**: 
  - 未選択時: 「選択」
  - 選択中時: 「選択中」（ハイライト表示）

#### 3. 選択中詳細表示
- **トレーナー名**
- **タイプ表示**
- **応援メッセージ例**: `supportiveWords`から3つまで表示
- **枠線**: トレーナータイプに応じたカラー

#### 4. 確定ボタン
- **状態管理**: 選択中トレーナーがいる場合のみ有効
- **アクション**: 選択を確定してメイン画面へ遷移

## 🎨 デザイン仕様

### カラーパレット
| トレーナータイプ | カラーコード | 用途 |
|-----------------|------------|------|
| エネルギッシュ    | #FF6B6B    | カード枠線、ボタン |
| 穏やか          | #4ECDC4    | カード枠線、ボタン |
| 厳格           | #FF9F43    | カード枠線、ボタン |
| 優しい          | #F7B731    | カード枠線、ボタン |
| やる気満々       | #5F27CD    | カード枠線、ボタン |
| デフォルト       | #007AFF    | フォールバック |

### 画像・音声ファイル
```typescript
// 画像ファイルパス（assets/images/trainers/）
const trainerImages = {
  akari: 'akari.png',     // あかり（エネルギッシュ）
  isuzu: 'isuzu.png',     // いすず（穏やか） 
  kana: 'kana.png',       // かな（厳格）
  mika: 'mika.png',       // みか（優しい）
  rin: 'rin.png'          // りん（やる気満々）
}

// 音声ファイルパス（assets/audio/trainers/）
const trainerAudio = {
  akari: 'akari.mp3',
  isuzu: 'isuzu.mp3',
  kana: 'kana.mp3',
  mika: 'mika.mp3',
  rin: 'rin.mp3'
}

// 旧データとの互換性マッピング（AssetManagerで使用）
const compatibilityMapping = {
  'ena': 'akari',      // 旧voicePrefix → 新ファイル名
  'calm': 'isuzu',     // 旧voicePrefix → 新ファイル名
  'shinji': 'isuzu',   // 旧設計 → 新ファイル名
  'takumi': 'kana',    // 旧設計 → 新ファイル名
  'miyuki': 'mika',    // 旧設計 → 新ファイル名
  'daiki': 'rin'       // 旧設計 → 新ファイル名
}

// プレースホルダー絵文字（画像がない場合）
const typeEmojis = {
  energetic: '✨',
  calm: '🌿', 
  strict: '💪',
  gentle: '🌸',
  motivational: '🔥'
}
```

### スタイリング
- **カード**: 角丸、シャドウ効果
- **選択状態**: 枠線とボタンのカラー変更
- **アニメーション**: タップ時のフィードバック

## ⚙️ 機能仕様

### データフロー
```
AppContext
├── trainers: TrainerModel[]    // 全トレーナー一覧
├── selectedTrainer            // 現在選択中のトレーナー
└── selectTrainer()           // トレーナー選択関数
```

### 状態管理
```typescript
const [localSelectedTrainer, setLocalSelectedTrainer] = useState(selectedTrainer);
```

### 主要関数

#### `getTypeDisplayName(type: string): string`
- **目的**: トレーナータイプの日本語名を取得
- **戻り値**: 「エネルギッシュ」「穏やか」など

#### `getTypeColor(type: string): string`
- **目的**: トレーナータイプに対応するカラーコードを取得
- **戻り値**: カラーコード文字列

#### `getTrainerImage(trainer: TrainerModel): any`
- **目的**: トレーナーオブジェクトから画像リソースを取得
- **フォールバック戦略**:
  1. `trainer.voicePrefix`を使用
  2. `trainer.avatarImageName`から拡張子を除去して使用
  3. `trainer.name`から日本語→ローマ字マッピング
- **戻り値**: 画像リソース（require文）またはnull

#### `getTrainerAudio(trainer: TrainerModel): any`
- **目的**: トレーナーオブジェクトから音声リソースを取得
- **フォールバック戦略**:
  1. `trainer.voicePrefix`を使用
  2. `trainer.name`から日本語→ローマ字マッピング
- **戻り値**: 音声リソース（require文）またはnull

#### `handleTrainerSelect(trainer: TrainerModel)`
- **目的**: トレーナーの一時選択（ローカル状態更新）
- **処理**: `localSelectedTrainer`を更新

#### `handleConfirmSelection()`
- **目的**: トレーナー選択の確定
- **処理**: 
  1. `selectTrainer()`を呼び出し
  2. 成功メッセージ表示
  3. 画面遷移

#### `playVoiceSample(trainer: TrainerModel)`
- **目的**: トレーナーの音声サンプル再生
- **処理**:
  1. 音声ファイルの存在確認
  2. Expo AV使用で音声再生
  3. ファイルがない場合はテキストメッセージ表示
  4. 再生完了後のリソース解放

## 🔧 技術仕様

### 使用コンポーネント
- `ScrollView`: メインコンテナ
- `TouchableOpacity`: タップ可能要素
- `Text`: テキスト表示
- `View`: レイアウトコンテナ
- `Image`: トレーナー画像表示
- `ActivityIndicator`: ローディング表示

### 使用ライブラリ
- `expo-av`: 音声ファイル再生
- `Audio.Sound`: 音声リソース管理

### アセット管理
- **AssetManager**: 静的リソース管理、互換性マッピング
- **AssetHelper**: データベースリセット、アセット状況確認ユーティリティ
- **互換性対応**: 旧データベースとの互換性維持

### エラーハンドリング
- **トレーナー選択失敗**: `ErrorHandler.handle()`でエラー処理
- **バリデーション**: `Validation`ユーティリティ使用
- **ローディング管理**: `LoadingManager`でローディング状態制御
- **JSON循環参照**: WatermelonDBオブジェクトの安全な表示処理
- **ファイル不在時**: プレースホルダー表示とフォールバック機能

### パフォーマンス
- **メモリ最適化**: 不要な再レンダリングを防止
- **音声再生**: 選択確定時のウェルカムメッセージ
- **ハプティックフィードバック**: タップ時の触覚フィードバック

## 📱 インタラクション

### 操作フロー
1. **画面表示** → トレーナー一覧をスクロール表示
2. **トレーナー選択** → カードタップで一時選択
3. **詳細確認** → 選択中詳細で応援メッセージ確認
4. **選択確定** → 確定ボタンで正式に選択完了

### フィードバック
- **視覚的**: 選択状態のカラー変更、ボタン状態変更、画像表示
- **聴覚的**: 声を聞くボタンでのトレーナー音声サンプル再生
- **触覚的**: タップ時のハプティックフィードバック
- **代替表示**: 画像・音声がない場合のプレースホルダー表示

## 🚀 実装ファイル

- **メインコンポーネント**: `src/screens/SimpleTrainerSelection.tsx`
- **スタイル**: コンポーネント内`StyleSheet`
- **型定義**: `src/types/Trainer.ts`
- **データモデル**: `src/database/models/Trainer.ts`

## 📋 テスト観点

### 単体テスト
- [ ] トレーナータイプ表示名の変換
- [ ] カラーコード取得
- [ ] 画像リソース取得
- [ ] 音声リソース取得
- [ ] 選択状態の更新
- [ ] プレースホルダー表示ロジック

### 統合テスト
- [ ] トレーナー一覧の表示
- [ ] 画像読み込み・表示
- [ ] 音声ファイル再生
- [ ] 選択状態の同期
- [ ] 確定処理の実行
- [ ] エラーハンドリング（ファイル不在時）

### UIテスト
- [ ] 全トレーナーカードの表示
- [ ] 選択状態の視覚的変化
- [ ] 確定ボタンの有効/無効状態
- [ ] スクロール動作

---

*📝 Created: 2025-08-20 | 🔄 Last Updated: 2025-08-25*

## 🔄 変更履歴

### 2025-08-25 更新
- **JSON循環参照エラー修正**: WatermelonDBオブジェクトの安全な表示処理を実装
- **トレーナー名変更**: 設計時の英語名から日本語名に変更（あかり、いすず、かな、みか、りん）
- **複雑なフォールバック機能**: voicePrefix → avatarImageName → name mapping の多段階フォールバック
- **データベース互換性**: 旧データとの互換性マッピング機能追加（ena→akari、calm→isuzuなど）
- **デバッグログ改善**: 安全なプロパティアクセスによるデバッグ情報表示
- **AssetManager強化**: 静的リソース管理と互換性マッピングの統合

### 2025-08-20 更新
- **アバター表示**: 絵文字から画像ファイル（PNG）に変更
- **音声機能**: 「声を聞く」ボタン追加、Expo AV使用
- **プレースホルダー**: 画像・音声がない場合の代替表示追加
- **ファイル構造**: assets/images/trainers/、assets/audio/trainers/ディレクトリ追加
- **エラーハンドリング**: ファイル不在時の適切な処理追加